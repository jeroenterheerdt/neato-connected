<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Neato LIDAR Viewer</title>
<style>
    body { background:#111; margin:0; overflow:hidden; font-family:Arial; color:white; }
    #controls {
        position:fixed; top:10px; left:10px;
        padding:10px; background:#222; border-radius:8px;
    }
    button {
        margin:3px;
        padding:8px;
        background:#444; color:white; border:none;
        border-radius:4px; cursor:pointer;
    }
    button:hover { background:#666; }
    canvas { display:block; margin:auto; }
</style>
</head>
<body>

<div id="controls">
    <button onclick="sendCmd('TestMode on')">TestMode ON</button>
    <button onclick="sendCmd('TestMode off')">TestMode OFF</button>
    <br>
    <button onclick="sendCmd('setldsrotation on')">Rotation ON</button>
    <button onclick="sendCmd('setldsrotation off')">Rotation OFF</button>
    <br>
    <button onclick="startAutoScan()">Start Auto-scan</button>
    <button onclick="stopAutoScan()">Stop Auto-scan</button>
</div>

<canvas id="c"></canvas>

<script>
const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");

function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}
resize();
window.onresize = resize;

// ---- WebSocket ----
const ws = new WebSocket(`ws://${location.host}`);

function sendCmd(cmd) {
    ws.send(JSON.stringify({ cmd }));
}

// ---- Auto-scan every 2 seconds ----
let autoScan = null;

function startAutoScan() {
    if (autoScan) return;
    sendCmd("getldsscan");
    autoScan = setInterval(() => {
        sendCmd("getldsscan");
    }, 500);
}

function stopAutoScan() {
    clearInterval(autoScan);
    autoScan = null;
}

let points = [];

ws.onmessage = (msg) => {
    const data = JSON.parse(msg.data);

    points.push(data);
    if (points.length > 360) points.shift();

    draw();
};

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    const cx = canvas.width / 2;
    const cy = canvas.height / 2;
    const maxR = Math.min(cx, cy) * 0.95;

    ctx.fillStyle = "lime";

    for (let p of points) {
        const rad = p.angle * Math.PI / 180;
        const r = (p.dist / 3.5) * maxR;

        const x = cx + Math.sin(rad) * r;
        const y = cy - Math.cos(rad) * r;

        ctx.fillRect(x, y, 3, 3);
    }

    ctx.strokeStyle = "#444";
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.arc(cx, cy, maxR, 0, Math.PI * 2);
    ctx.stroke();
}
</script>
</body>
</html>
